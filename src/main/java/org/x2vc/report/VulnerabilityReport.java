/*-
 * #%L
 * x2vc - XSLT XSS Vulnerability Checker
 * %%
 * Copyright (C) 2023 x2vc authors and contributors
 * %%
 * This program and the accompanying materials are made
 * available under the terms of the Eclipse Public License 2.0
 * which is available at https://www.eclipse.org/legal/epl-2.0/
 *
 * SPDX-License-Identifier: EPL-2.0
 * #L%
 */
package org.x2vc.report;

import java.net.URI;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.util.Collection;
import java.util.List;
import java.util.Objects;

import javax.xml.bind.annotation.XmlAttribute;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlElementWrapper;
import javax.xml.bind.annotation.XmlRootElement;
import javax.xml.bind.annotation.adapters.XmlJavaTypeAdapter;

import org.x2vc.stylesheet.coverage.CoverageStatistics;
import org.x2vc.stylesheet.coverage.ICoverageStatistics;
import org.x2vc.stylesheet.coverage.ILineCoverage;
import org.x2vc.stylesheet.coverage.LineCoverage;
import org.x2vc.utilities.jaxb.LocalDateTimeAdapter;

import com.google.common.base.Supplier;
import com.google.common.base.Suppliers;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.Lists;

/**
 * Standard implementation of {@link IVulnerabilityReport}.
 */
@XmlRootElement(name = "vulnerabilityReport")
public final class VulnerabilityReport implements IVulnerabilityReport {

	@XmlAttribute(name = "stylesheetURI")
	private final URI stylesheetURI;

	@XmlAttribute(name = "checkDate")
	@XmlJavaTypeAdapter(LocalDateTimeAdapter.class)
	private final LocalDateTime checkDate;

	@XmlElement(name = "coverage", type = CoverageStatistics.class)
	private final ICoverageStatistics coverageStatistics;

	@XmlElementWrapper(name = "sections")
	@XmlElement(name = "section", type = VulnerabilityReportSection.class)
	private final List<IVulnerabilityReportSection> sections;

	@XmlElementWrapper(name = "codeCoverage")
	@XmlElement(name = "line", type = LineCoverage.class)
	private final List<ILineCoverage> codeCoverage;

	@XmlElementWrapper(name = "messages")
	@XmlElement(name = "message", type = LogMessage.class)
	private final List<ILogMessage> messages;

	private VulnerabilityReport(Builder builder) {
		this.stylesheetURI = builder.stylesheetURI;
		this.checkDate = builder.checkDate;
		this.coverageStatistics = builder.coverageStatistics;
		this.sections = builder.sections;
		this.messages = builder.messages;
		this.codeCoverage = builder.codeCoverage;
	}

	private VulnerabilityReport() {
		// default constructor to make JAXB happy
		this.stylesheetURI = null;
		this.checkDate = null;
		this.coverageStatistics = null;
		this.sections = Lists.newArrayList();
		this.messages = Lists.newArrayList();
		this.codeCoverage = Lists.newArrayList();
	}

	@Override
	public URI getStylesheetURI() {
		return this.stylesheetURI;
	}

	@Override
	@XmlAttribute(name = "stylesheetFilename")
	public String getStylesheetFilename() {
		return Paths.get(this.stylesheetURI).getFileName().toString();
	}

	@Override
	public LocalDateTime getCheckDate() {
		return this.checkDate;
	}

	@SuppressWarnings({
			"java:S4738", // Java supplier does not support memoization
			"java:S2065" // transient marker used to exclude supplier from JAXB and EqualsVerifier
	})
	private transient Supplier<Integer> issueNumberSupplier = Suppliers
		.memoize(() -> this.getSections().stream().mapToInt(s -> s.getIssues().size()).sum());

	@Override
	@XmlAttribute(name = "totalIssues")
	public Integer getTotalNumberOfIssues() {
		return this.issueNumberSupplier.get();
	}

	@Override
	public ICoverageStatistics getCoverageStatistics() {
		return this.coverageStatistics;
	}

	@Override
	public ImmutableList<ILogMessage> getMessages() {
		return ImmutableList.copyOf(this.messages);
	}

	@Override
	public ImmutableList<IVulnerabilityReportSection> getSections() {
		return ImmutableList.copyOf(this.sections);
	}

	@Override
	public ImmutableList<ILineCoverage> getCodeCoverage() {
		return ImmutableList.copyOf(this.codeCoverage);
	}

	@Override
	public int hashCode() {
		return Objects.hash(this.checkDate, this.codeCoverage, this.coverageStatistics, this.messages, this.sections,
				this.stylesheetURI);
	}

	@Override
	public boolean equals(Object obj) {
		if (this == obj) {
			return true;
		}
		if (!(obj instanceof VulnerabilityReport)) {
			return false;
		}
		final VulnerabilityReport other = (VulnerabilityReport) obj;
		return Objects.equals(this.checkDate, other.checkDate) && Objects.equals(this.codeCoverage, other.codeCoverage)
				&& Objects.equals(this.coverageStatistics, other.coverageStatistics)
				&& Objects.equals(this.messages, other.messages) && Objects.equals(this.sections, other.sections)
				&& Objects.equals(this.stylesheetURI, other.stylesheetURI);
	}

	/**
	 * Provides a builder to create a report instance.
	 *
	 * @param stylesheetURI
	 * @return a new builder
	 */
	public static Builder builder(URI stylesheetURI) {
		return new Builder(stylesheetURI);
	}

	/**
	 * Builder to build {@link VulnerabilityReport}.
	 */
	public static final class Builder {
		private URI stylesheetURI;
		private LocalDateTime checkDate = LocalDateTime.now();
		private ICoverageStatistics coverageStatistics;
		private List<IVulnerabilityReportSection> sections = Lists.newArrayList();
		private List<ILogMessage> messages = Lists.newArrayList();
		private List<ILineCoverage> codeCoverage = Lists.newArrayList();

		private Builder(URI stylesheetURI) {
			this.stylesheetURI = stylesheetURI;
		}

		/**
		 * Builder method for checkDate parameter.
		 *
		 * @param checkDate field to set
		 * @return builder
		 */
		public Builder withCheckDate(LocalDateTime checkDate) {
			this.checkDate = checkDate;
			return this;
		}

		/**
		 * Builder method for coverageStatistics parameter.
		 *
		 * @param coverageStatistics field to set
		 * @return builder
		 */
		public Builder withCoverageStatistics(ICoverageStatistics coverageStatistics) {
			this.coverageStatistics = coverageStatistics;
			return this;
		}

		/**
		 * Builder method for messages parameter.
		 *
		 * @param message field to set
		 * @return builder
		 */
		public Builder addMessage(ILogMessage message) {
			this.messages.add(message);
			return this;
		}

		/**
		 * Builder method for messages parameter.
		 *
		 * @param messages field to set
		 * @return builder
		 */
		public Builder addMessages(List<ILogMessage> messages) {
			this.messages.addAll(messages);
			return this;
		}

		/**
		 * Builder method for sections parameter.
		 *
		 * @param section field to set
		 * @return builder
		 */
		public Builder addSection(IVulnerabilityReportSection section) {
			this.sections.add(section);
			return this;
		}

		/**
		 * Builder method for sections parameter.
		 *
		 * @param sections field to set
		 * @return builder
		 */
		public Builder addSections(Collection<IVulnerabilityReportSection> sections) {
			this.sections.addAll(sections);
			return this;
		}

		/**
		 * Builder method for codeCoverage parameter.
		 *
		 * @param codeCoverage field to set
		 * @return builder
		 */
		public Builder withCodeCoverage(List<ILineCoverage> codeCoverage) {
			this.codeCoverage.addAll(codeCoverage);
			return this;
		}

		/**
		 * Builder method of the builder.
		 *
		 * @return built class
		 */
		public VulnerabilityReport build() {
			return new VulnerabilityReport(this);
		}
	}

}
